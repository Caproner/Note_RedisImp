# 第6章 整数集合

整数集合用于存储少量整数的集合对象。

其作为一种压缩结构，核心思想为时间换空间。

## 整数集合的实现

其存储方式十分简单，就是一个**有序数组**。

不过区别于普通的数组，其多加了一个字段定义了其编码方式，使得数组严格地讲被视为一段连续位空间操作。

其定义如下：

```c
typedef struct intset {
  uint32_t encoding;
  uint32_t length;
  int8_t contents[];
} intset;
```

主体显然是`contents`数组，其存储被有序排列的元素。其虽然被定义为`int8_t`，不过事实上其类型实际上是由`encoding`变量定义的。

`encoding`变量用于存放**表示数组数据类型的宏定义整数**（例如`INTSET_ENC_INT116`，事实上其为一个宏定义常量），其有16位、32位、64位三种。

`length`用于存放数组长度。准确地说是数组中的元素个数。

## 升级

一开始定义的时候，整数集合的位数可能只有16位（数字足够小的话）。但如果这个时候有超出这个范围的数字插入时，整数集合的位数就要做改变，也就是升级。

升级的步骤包括：

+ 根据新元素决定整数集合的新位数，并分配空间
+ 将现有元素挪到其更新位数之后所在的位置
  + 假设整数集合为16位，其第一个元素占据第0~15位，则升级成32位之后，第一个元素就会占据第0~31位，故该元素在升级的时候就需要往后挪16位，并将前16位清空
+ 插入新元素
  + 会迫使整数集合升级的新元素一般要么比现有所有元素都大，要么比现有所有元素都小。故新元素只会插入到最右边或最左边

+ 更新`encoding`变量

整个过程的时间复杂度为$O(N)$

**整数集合不支持降级**

